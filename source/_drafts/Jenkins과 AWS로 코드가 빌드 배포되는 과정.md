---
title: Jenkins과 AWS로 코드가 빌드 배포되는 과정
catalog: true
date: 2019-08-22 21:53:55
subtitle: 
header-img: "bg_computer.jpg"
tags: 
- Experience
catagories:
- AWS
---


### 개발서버에 어떻게 배포 되고 있는 것일까?? 

문득 사내에서 개발서버에 배포 할 때 Jenkins에서 버튼 딸깍 딸깍 하고 있는데 이것이 어떻게 빌드 되고 AWS로 어떻게 가는거지? 궁금해졌다. AWS도 잘모르는데 이참에 배포되는 과정을 조사해 보고자 한다.

우선 배포되는 과정은 아래 이미지와 같다.
{% asset_img "jenkins-deploy-process.png" %}


### 1. 코드리뷰 그리고 PR

Bitbucket으로 PR을 날리고 승인되면 devel이라는 브랜치로 코드가 병합 된다.

### 2. Jenkins이 빌드하여 빌드결과 파일을 S3로 전송

Jenkins에서 빌드 담당자가 빌드할 브랜치를 선택하고 Job을 실행하면 Gradle이 빌드를 시작한다.  

빌드를 하면서 아래에 프로세스를 거치게 된다.

- 코드정적 분석 (Intellij Checkstyle 데로 코드가 작성되어 있는지 체크한다. 실패시 빌드 fail)
- 테스트 코드 수행
- 정적 리소스 파일 Timestamp로 버전 업데이트 (캐쉬를 무효화하고 수정된 버전을 적용시키기 위해)
- 빌드된 결과 파일을 tar로 archive하고 그외 정적 리소스 파일(js, css, image 등)을 S3로 전송함

여기서 중요한것은 빌드 파일이 S3로 갈 때, S3의 bucket이 다르다. tar 파일은 A라는 Bucket에서 관리하고 정적 리소스파일은 B 라는 Bucket으로 간다. 원래 정적 리소스 파일은 웹서버 내에서 관리 되었는데 CDN으로 활용하고자 S3에 static 디렉토리 별도에 두고 서비스 하기 위해 구분하여 배포하게 되었다.

### 3,4 Code Deploy에서 S3에서 변경감지를 하여 서버 배포 및 재시작

Jenkins에 역활을 빌드를 수행하고 결과물을 S3에 쏘는데 까지만이다. 나머지는 AWS에서 제공하는 Code Deploy 서비스를 이용하여 S3에 파일이 변경된 것을 감지하여 EC2서버에 코드를 배포한다.  

그리고 소스가 반영되고 재시작되어 배포는 마무리 된다.


### 조사 할 것

### 정적 리소스 파일 삭제시 S3에 싱크됨?

이전에는 rsync로 파일에 대한 동기화가 됬었는데 S3에서는 파일이 추가만 되지 파일을 삭제하고 S3로 쏴도 파일 삭제가 되지 않았다. 풀어야 할 과제이며 해결시 반드시 포스팅 업데이트 해야 한다.